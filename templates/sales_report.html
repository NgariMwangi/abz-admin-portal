{% extends "navbars.html" %}

{% block title %}Sales Report - ABZ Admin Portal{% endblock %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">
          Sales Report
          {% if selected_branch %}
            - {{ selected_branch.name }}
          {% endif %}
        </h3>
        <h6 class="op-7 mb-2">
          {% if selected_branch %}
            Track revenue, payments, and sales performance for {{ selected_branch.name }}
          {% else %}
            Track revenue, payments, and sales performance across all branches
          {% endif %}
        </h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary mr-2">
          <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
        <button type="button" class="btn btn-success" onclick="exportReport()">
          <i class="fas fa-download mr-2"></i>Export Report
        </button>
      </div>
    </div>

            <!-- Date Filter -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <form method="GET">
                                {% if current_branch_id %}
                                <input type="hidden" name="branch_id" value="{{ current_branch_id }}">
                                {% endif %}
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="start_date">Start Date</label>
                                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="end_date">End Date</label>
                                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>&nbsp;</label>
                                            <div>
                                                <button type="submit" class="btn btn-primary mr-2">
                                                    <i class="fas fa-filter mr-1"></i>Apply Filter
                                                </button>
                                                <a href="{{ url_for('sales_report', branch_id=current_branch_id) if current_branch_id else url_for('sales_report') }}" class="btn btn-outline-secondary">
                                                    <i class="fas fa-times mr-1"></i>Reset
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>&nbsp;</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-outline-primary" onclick="setDateRange(7)">7 Days</button>
                                                <button type="button" class="btn btn-outline-primary" onclick="setDateRange(30)">30 Days</button>
                                                <button type="button" class="btn btn-outline-primary" onclick="setDateRange(90)">90 Days</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card card-round">
                        <div class="card-body text-center">
                            <div class="icon-big text-center icon-primary bubble-shadow-small mb-3">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <h4 class="card-title">{{ "{:,.0f}".format(total_revenue|default(0)) }}</h4>
                            <p class="card-category">Total Revenue (KSH)</p>
                            <p class="text-muted small">{{ start_date }} to {{ end_date }}</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card card-round">
                        <div class="card-body text-center">
                            <div class="icon-big text-center icon-success bubble-shadow-small mb-3">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <h4 class="card-title">{{ total_payments|default(0) }}</h4>
                            <p class="card-category">Total Payments</p>
                            <p class="text-muted small">Completed payments</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card card-round">
                        <div class="card-body text-center">
                            <div class="icon-big text-center icon-info bubble-shadow-small mb-3">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h4 class="card-title">{{ "{:,.0f}".format(total_profit|default(0)) }}</h4>
                            <p class="card-category">Total Profit (KSH)</p>
                            <p class="text-muted small">Profit from sales</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Chart -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-area mr-2"></i>Revenue Trend
                            </div>
                        </div>
                        <div class="card-body">
                            {% if sales_data %}
                            <div style="height: 400px; width: 100%;">
                                <canvas id="salesChart" width="100%" height="400"></canvas>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">No sales data available</h5>
                                <p class="text-muted">Select a different date range to view sales data.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Data Table -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-table mr-2"></i>Daily Sales Breakdown
                            </div>
                        </div>
                        <div class="card-body">
                            {% if sales_data %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Payments Count</th>
                                            <th>Revenue</th>
                                            <th>Profit</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in sales_data %}
                                        <tr>
                                            <td>
                                                <strong>{{ row.date.strftime('%B %d, %Y') }}</strong>
                                                <br>
                                                <small class="text-muted">{{ row.date.strftime('%A') }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ row.payment_count }}</span>
                                            </td>
                                            <td>
                                                <strong class="text-success">KSH {{ "{:,.0f}".format(row.total_amount|default(0)) }}</strong>
                                            </td>
                                            <td>
                                                <strong class="text-info">KSH {{ "{:,.0f}".format(row.total_profit|default(0)) }}</strong>
                                            </td>
                                            <td>
                                                <a href="{{ url_for('daily_sales_details', date=row.date.strftime('%Y-%m-%d')) }}{% if current_branch_id %}?branch_id={{ current_branch_id }}{% endif %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>View Details
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th>Total</th>
                                            <th><span class="badge bg-primary">{{ total_payments }}</span></th>
                                            <th><strong class="text-success">KSH {{ "{:,.0f}".format(total_revenue) }}</strong></th>
                                            <th><strong class="text-info">KSH {{ "{:,.0f}".format(total_profit) }}</strong></th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No sales data found</h5>
                                <p class="text-muted">Try adjusting your date range to see sales data.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Date range shortcuts
function setDateRange(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - days);
    
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    
    // Submit the form to apply the date range
    const form = document.querySelector('form');
    form.submit();
}

// Export functionality
function exportReport() {
    // Get current date range and branch
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const branchId = '{{ current_branch_id }}' || '';
    
    // Create export URL
    let exportUrl = '{{ url_for("sales_report") }}?start_date=' + startDate + '&end_date=' + endDate;
    if (branchId) {
        exportUrl += '&branch_id=' + branchId;
    }
    exportUrl += '&export=csv';
    
    // Trigger download
    window.open(exportUrl, '_blank');
}

// Sales Chart
{% if sales_data %}
const ctx = document.getElementById('salesChart').getContext('2d');
const salesChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for row in sales_data %}'{{ row.date.strftime('%m/%d') }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Daily Revenue (KSH)',
            data: [{% for row in sales_data %}{{ row.total_amount|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true,
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
            mode: 'index'
        },
        plugins: {
            title: {
                display: true,
                text: 'Revenue Trend ({{ start_date }} to {{ end_date }})',
                font: {
                    size: 16,
                    weight: 'bold'
                },
                padding: {
                    top: 10,
                    bottom: 30
                }
            },
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: {
                        size: 12
                    },
                    padding: 20
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                borderColor: 'rgb(75, 192, 192)',
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Date',
                    font: {
                        size: 12,
                        weight: 'bold'
                    }
                },
                grid: {
                    display: true,
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                    font: {
                        size: 11
                    }
                }
            },
            y: {
                beginAtZero: true,
                display: true,
                title: {
                    display: true,
                    text: 'Revenue (KSH)',
                    font: {
                        size: 12,
                        weight: 'bold'
                    }
                },
                grid: {
                    display: true,
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                    font: {
                        size: 11
                    },
                    callback: function(value) {
                        return 'KSH ' + value.toLocaleString();
                    }
                }
            }
        }
    }
});
{% endif %}
</script>

{% endblock %}

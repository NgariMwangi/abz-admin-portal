{% extends "navbars.html" %}

{% block title %}Daily Sales Details - {{ date.strftime('%B %d, %Y') }}{% endblock %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">Daily Sales Details</h3>
        <h6 class="op-7 mb-2">{{ date.strftime('%A, %B %d, %Y') }}</h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{{ url_for('sales_report') }}" class="btn btn-outline-secondary mr-2">
          <i class="fas fa-arrow-left mr-2"></i>Back to Sales Report
        </a>
        <a href="{{ url_for('export_daily_sales_pdf', date=date.strftime('%Y-%m-%d')) }}{% if request.args.get('branch_id') %}?branch_id={{ request.args.get('branch_id') }}{% endif %}" class="btn btn-success">
          <i class="fas fa-file-pdf mr-2"></i>Export PDF
        </a>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card card-round">
          <div class="card-body text-center">
            <div class="icon-big text-center icon-primary bubble-shadow-small mb-3">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <h4 class="card-title">{{ "{:,.0f}".format(total_revenue|default(0)) }}</h4>
            <p class="card-category">Total Revenue (KSH)</p>
            <p class="text-muted small">{{ date.strftime('%B %d, %Y') }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card card-round">
          <div class="card-body text-center">
            <div class="icon-big text-center icon-success bubble-shadow-small mb-3">
              <i class="fas fa-credit-card"></i>
            </div>
            <h4 class="card-title">{{ total_payments|default(0) }}</h4>
            <p class="card-category">Total Payments</p>
            <p class="text-muted small">Completed payments</p>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card card-round">
          <div class="card-body text-center">
            <div class="icon-big text-center icon-info bubble-shadow-small mb-3">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <h4 class="card-title">{{ "{:,.0f}".format(total_items|default(0)) }}</h4>
            <p class="card-category">Total Items Sold</p>
            <p class="text-muted small">Items sold</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Payments Table -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-credit-card mr-2"></i>Payment Details
            </div>
          </div>
                        <div class="card-body">
                            {% if payments %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Payment ID</th>
                                            <th>Order ID</th>
                                            <th>Amount</th>
                                            <th>Payment Method</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in payments %}
                                        <tr>
                                            <td>
                                                <strong>#{{ payment.id }}</strong>
                                            </td>
                                            <td>
                                                <a href="{{ url_for('order_details', order_id=payment.order.id) }}" class="text-primary">
                                                    #{{ payment.order.id }}
                                                </a>
                                            </td>
                                            <td>
                                                <strong class="text-success">KSH {{ "{:,.0f}".format(payment.amount) }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ payment.payment_method.title() }}</span>
                                            </td>
                                            <td>
                                                {{ payment.created_at.strftime('%H:%M:%S') }}
                                            </td>
                                            <td>
                                                <span class="badge bg-success">{{ payment.payment_status.title() }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th>Total</th>
                                            <th>{{ payments|length }} payments</th>
                                            <th><strong class="text-success">KSH {{ "{:,.0f}".format(total_revenue) }}</strong></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-credit-card fa-2x text-muted mb-3"></i>
                                <h6 class="text-muted">No payments found for this date</h6>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

    <!-- Order Items Table -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <i class="fas fa-shopping-cart mr-2"></i>Items Sold
            </div>
          </div>
                        <div class="card-body">
                            {% if order_items %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Product Name</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total Price</th>
                                            <th>Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in order_items %}
                                        <tr>
                                            <td>
                                                <a href="{{ url_for('order_details', order_id=item.order.id) }}" class="text-primary">
                                                    #{{ item.order.id }}
                                                </a>
                                            </td>
                                            <td>
                                                <strong>{{ item.product_name or 'Manual Item' }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ "{:,.0f}".format(item.quantity) }}</span>
                                            </td>
                                            <td>
                                                KSH {{ "{:,.0f}".format(item.final_price|default(0)) }}
                                            </td>
                                            <td>
                                                <strong class="text-success">KSH {{ "{:,.0f}".format((item.quantity * item.final_price)|default(0)) }}</strong>
                                            </td>
                                            <td>
                                                {{ item.created_at.strftime('%H:%M:%S') }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <th>Total</th>
                                            <th>{{ order_items|length }} items</th>
                                            <th><span class="badge bg-primary">{{ "{:,.0f}".format(total_items) }}</span></th>
                                            <th></th>
                                            <th><strong class="text-success">KSH {{ "{:,.0f}".format(total_revenue) }}</strong></th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-shopping-cart fa-2x text-muted mb-3"></i>
                                <h6 class="text-muted">No items sold on this date</h6>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
  </div>
</div>

<script>
function exportDailyReport() {
    // Get current date
    const date = "{{ date.strftime('%Y-%m-%d') }}";
    
    // Create export URL
    const exportUrl = `{{ url_for('daily_sales_details', date=date) }}?export=csv`;
    
    // Trigger download
    window.open(exportUrl, '_blank');
}
</script>

{% endblock %}

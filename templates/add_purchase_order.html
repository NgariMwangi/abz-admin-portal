{% extends "navbars.html" %}

{% block content %}
<div class="container">
  <div class="page-inner">
    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">Create Purchase Order</h3>
        <h6 class="op-7 mb-2">Create a new purchase order</h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary btn-round">
          <i class="fas fa-arrow-left"></i> Back to Purchase Orders
        </a>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Create Purchase Order Form -->
    <div class="row">
      <div class="col-md-8">
        <div class="card card-round">
          <div class="card-header">
            <h4 class="card-title">Purchase Order Information</h4>
          </div>
          <div class="card-body">
            <form method="POST">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="supplier_id" class="form-label">Supplier *</label>
                    <select class="form-control" id="supplier_id" name="supplier_id" required>
                      <option value="">Select Supplier</option>
                      {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">
                      Choose the supplier for this purchase order
                    </small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="branch_id" class="form-label">Branch *</label>
                    <select class="form-control" id="branch_id" name="branch_id" required>
                      <option value="">Select Branch</option>
                      {% for branch in branches %}
                        <option value="{{ branch.id }}">{{ branch.name }}</option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">
                      Choose the branch for this purchase order
                    </small>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="order_date" class="form-label">Order Date *</label>
                    <input type="date" class="form-control" id="order_date" name="order_date" 
                           value="{{ today }}" required>
                    <small class="form-text text-muted">
                      Date when the order is placed
                    </small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="expected_delivery_date" class="form-label">Expected Delivery Date</label>
                    <input type="date" class="form-control" id="expected_delivery_date" name="expected_delivery_date">
                    <small class="form-text text-muted">
                      Expected date of delivery (optional)
                    </small>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3" 
                          placeholder="Any additional notes about this purchase order..."></textarea>
                <small class="form-text text-muted">
                  Optional notes about this purchase order
                </small>
              </div>

              <!-- Purchase Order Items Section -->
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">Purchase Order Items</h5>
                  <button type="button" class="btn btn-success btn-sm" onclick="addItemRow()">
                    <i class="fas fa-plus"></i> Add Item
                  </button>
                </div>
                
                <div id="items-container">
                  <!-- Items will be added here dynamically -->
                </div>
                
                <div class="text-center mt-3">
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItemRow()">
                    <i class="fas fa-plus"></i> Add Another Item
                  </button>
                </div>
              </div>

              <div class="mb-3">
                <button type="submit" class="btn btn-primary btn-round">
                  <i class="fas fa-save"></i> Create Purchase Order
                </button>
                <a href="{{ url_for('purchase_orders') }}" class="btn btn-secondary btn-round ms-2">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card card-round">
          <div class="card-header">
            <h4 class="card-title">Guidelines</h4>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="fas fa-truck text-info"></i>
                <strong>Supplier:</strong> Choose an active supplier
              </li>
              <li class="mb-2">
                <i class="fas fa-building text-info"></i>
                <strong>Branch:</strong> Select the receiving branch
              </li>
              <li class="mb-2">
                <i class="fas fa-calendar text-info"></i>
                <strong>Order Date:</strong> Date when order is placed
              </li>
              <li class="mb-2">
                <i class="fas fa-clock text-info"></i>
                <strong>Delivery Date:</strong> Expected delivery (optional)
              </li>
              <li class="mb-2">
                <i class="fas fa-sticky-note text-info"></i>
                <strong>Notes:</strong> Additional information
              </li>
            </ul>
          </div>
        </div>

        <div class="card card-round mt-3">
          <div class="card-header">
            <h4 class="card-title">Adding Items</h4>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="fas fa-plus text-success"></i>
                <strong>Manual Entry:</strong> Type product code, name, quantity, and notes
              </li>
              <li class="mb-2">
                <i class="fas fa-database text-info"></i>
                <strong>From Database:</strong> Select existing products to auto-fill details
              </li>
              <li class="mb-2">
                <i class="fas fa-edit text-warning"></i>
                <strong>Edit Later:</strong> Items can be modified after creation
              </li>
              <li class="mb-2">
                <i class="fas fa-trash text-danger"></i>
                <strong>Remove Items:</strong> Use the delete button to remove unwanted items
              </li>
            </ul>
          </div>
        </div>

        <div class="card card-round mt-3">
          <div class="card-header">
            <h4 class="card-title">Next Steps</h4>
          </div>
          <div class="card-body">
            <ol class="list-unstyled">
              <li class="mb-2">
                <strong>1.</strong> Create the purchase order with items
              </li>
              <li class="mb-2">
                <strong>2.</strong> Review and edit items if needed
              </li>
              <li class="mb-2">
                <strong>3.</strong> Submit for approval
              </li>
              <li class="mb-2">
                <strong>4.</strong> Order from supplier
              </li>
              <li class="mb-2">
                <strong>5.</strong> Receive items
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Set today's date as default for order date
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('order_date').value = today;
    
    // Add initial item row
    addItemRow();
});

let itemCounter = 0;

function addItemRow() {
    itemCounter++;
    const container = document.getElementById('items-container');
    
    const itemRow = document.createElement('div');
    itemRow.className = 'item-row border rounded p-3 mb-3';
    itemRow.id = `item-${itemCounter}`;
    
    itemRow.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <div class="mb-2">
                    <label class="form-label small">Product Code</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="product_code_${itemCounter}" 
                           placeholder="e.g., PROD001">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-2">
                    <label class="form-label small">Product Name</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="product_name_${itemCounter}" 
                           placeholder="Product name">
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-2">
                    <label class="form-label small">Quantity *</label>
                    <input type="number" class="form-control form-control-sm" 
                           name="quantity_${itemCounter}" 
                           min="1" value="1" required>
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-2">
                    <label class="form-label small">Unit</label>
                    <select class="form-control form-control-sm" 
                            name="unit_${itemCounter}">
                        <option value="pieces">Pieces</option>
                        <option value="box">Box</option>
                        <option value="carton">Carton</option>
                        <option value="sack">Sack</option>
                        <option value="packet">Packet</option>
                        <option value="kg">Kilogram</option>
                        <option value="g">Gram</option>
                        <option value="liter">Liter</option>
                        <option value="ml">Milliliter</option>
                        <option value="meter">Meter</option>
                        <option value="cm">Centimeter</option>
                        <option value="dozen">Dozen</option>
                        <option value="pack">Pack</option>
                        <option value="set">Set</option>
                        <option value="pair">Pair</option>
                        <option value="roll">Roll</option>
                        <option value="rolls">Rolls</option>
                        <option value="sheet">Sheet</option>
                        <option value="unit">Unit</option>
                    </select>
                </div>
            </div>
            <div class="col-md-1">
                <div class="mb-2">
                    <label class="form-label small">&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm w-100" 
                            onclick="removeItemRow(${itemCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Product Selection from Database -->
        <div class="row mt-2">
            <div class="col-12">
                <div class="mb-2">
                    <label class="form-label small">Or Select from Existing Products</label>
                    <select class="form-control form-control-sm" 
                            onchange="fillProductDetails(this, ${itemCounter})">
                        <option value="">-- Select Product --</option>
                        {% for product in products %}
                            <option value="{{ product.id }}" 
                                    data-code="{{ product.productcode or '' }}" 
                                    data-name="{{ product.name }}">
                                {{ product.name }} ({{ product.productcode or 'No Code' }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Hidden input for form submission -->
        <input type="hidden" name="items_data" 
               value="" id="item_data_${itemCounter}">
    `;
    
    container.appendChild(itemRow);
    updateItemData(itemCounter);
}

function removeItemRow(itemId) {
    const itemRow = document.getElementById(`item-${itemId}`);
    if (itemRow) {
        itemRow.remove();
    }
}

function fillProductDetails(selectElement, itemId) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (selectedOption.value) {
        const productCode = selectedOption.getAttribute('data-code') || '';
        const productName = selectedOption.getAttribute('data-name') || '';
        
        const itemRow = document.getElementById(`item-${itemId}`);
        itemRow.querySelector(`input[name="product_code_${itemId}"]`).value = productCode;
        itemRow.querySelector(`input[name="product_name_${itemId}"]`).value = productName;
        
        updateItemData(itemId);
    }
}

function updateItemData(itemId) {
    const itemRow = document.getElementById(`item-${itemId}`);
    if (itemRow) {
        const productCode = itemRow.querySelector(`input[name="product_code_${itemId}"]`).value;
        const productName = itemRow.querySelector(`input[name="product_name_${itemId}"]`).value;
        const quantity = itemRow.querySelector(`input[name="quantity_${itemId}"]`).value;
        const unit = itemRow.querySelector(`select[name="unit_${itemId}"]`).value;
        
        const itemData = `${productCode}|${productName}|${quantity}|${unit}`;
        itemRow.querySelector(`input[name="items_data"]`).value = itemData;
    }
}

// Update item data when inputs change
document.addEventListener('input', function(e) {
    if (e.target.name && (e.target.name.startsWith('product_code_') || 
                          e.target.name.startsWith('product_name_') || 
                          e.target.name.startsWith('quantity_'))) {
        const itemId = e.target.name.split('_').pop();
        updateItemData(itemId);
    }
});

// Update item data when select fields change
document.addEventListener('change', function(e) {
    if (e.target.name && e.target.name.startsWith('unit_')) {
        const itemId = e.target.name.split('_').pop();
        updateItemData(itemId);
    }
});

// Form validation before submission
document.querySelector('form').addEventListener('submit', function(e) {
    const itemRows = document.querySelectorAll('.item-row');
    let hasValidItems = false;
    
    itemRows.forEach(row => {
        const productCode = row.querySelector('input[name^="product_code_"]').value.trim();
        const productName = row.querySelector('input[name^="product_name_"]').value.trim();
        const quantity = row.querySelector('input[name^="quantity_"]').value.trim();
        
        // At least one of product name or product code must be provided, plus quantity
        if ((productCode || productName) && quantity) {
            hasValidItems = true;
        }
    });
    
    if (!hasValidItems) {
        e.preventDefault();
        alert('Please add at least one valid item to the purchase order. Each item must have either a product name or product code (or both), plus a quantity.');
        return false;
    }
    
    // Update all item data before submission
    itemRows.forEach(row => {
        const itemId = row.id.split('-')[1];
        updateItemData(itemId);
    });
});
</script>
{% endblock %} 
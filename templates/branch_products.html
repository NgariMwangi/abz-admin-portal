{% extends "navbars.html" %}

<!-- END nav -->
{% block content %}
<style>
.action-buttons {
  display: flex;
  gap: 2px;
  flex-wrap: wrap;
}
.action-buttons .btn {
  min-width: 32px;
  height: 32px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* Search Bar Styling */
.search-container {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid #e9ecef;
}

.search-container .input-group {
  margin-bottom: 10px;
}

.search-container .form-control {
  border-radius: 6px;
}

.search-container .input-group-text {
  background-color: #fff;
  border-right: none;
}

.search-container .form-control {
  border-left: none;
}

.search-container .form-control:focus {
  box-shadow: none;
  border-color: #ced4da;
}

/* Filter Styling */
.filter-container {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-container .form-control {
  min-width: 150px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .filter-container {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-container .form-control {
    min-width: auto;
  }
}

/* Branch Header Styling */
.branch-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.branch-header h2 {
  margin: 0;
  font-weight: 600;
}

.branch-header p {
  margin: 5px 0 0 0;
  opacity: 0.9;
}

.branch-stats {
  display: flex;
  gap: 20px;
  margin-top: 15px;
}

.stat-item {
  text-align: center;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  min-width: 100px;
}

.stat-number {
  font-size: 24px;
  font-weight: bold;
  display: block;
}

.stat-label {
  font-size: 12px;
  opacity: 0.8;
}
</style>

<!-- Include search functionality -->
<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<div class="container">
  <div class="page-inner">
    <!-- Branch Header -->
    <div class="branch-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2>{{ branch.name }}</h2>
          <p>{{ branch.location }}</p>
        </div>
        <div class="branch-stats">
          <div class="stat-item">
            <span class="stat-number">{{ products|length }}</span>
            <span class="stat-label">Products</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ products|selectattr('display', 'equalto', true)|list|length }}</span>
            <span class="stat-label">Visible</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ products|sum(attribute='stock') }}</span>
            <span class="stat-label">Total Stock</span>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
      <div>
        <h3 class="fw-bold mb-3">Branch Products</h3>
        <h6 class="op-7 mb-2">Manage products for {{ branch.name }} branch</h6>
      </div>
      <div class="ms-md-auto py-2 py-md-0">
        <a href="{{ url_for('products') }}" class="btn btn-secondary btn-round">
          <i class="fas fa-arrow-left"></i> All Products
        </a>
        <button class="btn btn-primary btn-round ms-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
          Add Product
        </button>
      </div>
    </div>

    <!-- Products Section -->
    <div class="row mt-4">
      <div class="col-md-12">
        <div class="card card-round">
          <div class="card-header">
            <div class="card-head-row">
              <h4 class="card-title">
                Products - {{ branch.name }}
              </h4>
              <div class="card-tools">
                <button class="btn btn-icon btn-link btn-primary btn-xs" data-bs-toggle="collapse" data-bs-target="#productsCollapse">
                  <span class="fa fa-angle-down"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body collapse show" id="productsCollapse">
            <!-- Products Search Bar -->
            <div class="search-container">
              <div class="filter-container">
                <form method="GET" action="{{ url_for('branch_products', branch_id=branch.id) }}" class="row g-3">
                  <div class="col-md-3">
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                      <input type="text" class="form-control" id="productSearch" name="search" 
                             value="{{ search }}" placeholder="Search products by name, code, or category...">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <select class="form-control" id="categoryFilter" name="category">
                      <option value="">All Categories</option>
                      {% for subcategory in subcategories %}
                      <option value="{{ subcategory.name }}" {% if category_filter == subcategory.name %}selected{% endif %}>
                        {{ subcategory.name }} ({{ subcategory.category.name }})
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" id="displayFilter" name="display">
                      <option value="">All Products</option>
                      <option value="true" {% if display_filter == 'true' %}selected{% endif %}>Visible Only</option>
                      <option value="false" {% if display_filter == 'false' %}selected{% endif %}>Hidden Only</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-control" name="per_page">
                      <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10 per page</option>
                      <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25 per page</option>
                      <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50 per page</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-search"></i> Search
                    </button>
                    <a href="{{ url_for('branch_products', branch_id=branch.id) }}" class="btn btn-secondary">
                      <i class="fas fa-times"></i> Clear
                    </a>
                  </div>
                </form>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover" id="productsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Buying Price</th>
                    <th>Selling Price</th>
                    <th>Stock</th>
                    <th>Product Code</th>
                    <th>Display</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in products %}
                  <tr>
                    <td>{{ product.id }}</td>
                    <td>
                      {% if product.image_url %}
                      <img src="{{ product.image_url }}" alt="{{ product.name }}" style="width: 50px; height: 50px; object-fit: cover;">
                      {% else %}
                      <span class="text-muted">No image</span>
                      {% endif %}
                    </td>
                    <td>{{ product.name }}</td>
                    <td>
                      {% if product.sub_category %}
                        {{ product.sub_category.name }} ({{ product.sub_category.category.name }})
                      {% else %}
                        <span class="text-muted">No category</span>
                      {% endif %}
                    </td>
                    <td>{{ product.buyingprice or 'N/A' }}</td>
                    <td>{{ product.sellingprice or 'N/A' }}</td>
                    <td>
                      <span class="badge {% if product.stock > 10 %}badge-success{% elif product.stock > 0 %}badge-warning{% else %}badge-danger{% endif %}">
                        {{ product.stock or 0 }}
                      </span>
                    </td>
                    <td>{{ product.productcode or 'N/A' }}</td>
                    <td>
                      <span class="badge {% if product.display %}badge-success{% else %}badge-secondary{% endif %}">
                        {{ 'Visible' if product.display else 'Hidden' }}
                      </span>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-info" onclick="viewProduct({{ product.id }})" title="View Details">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editProduct({{ product.id }})" title="Edit">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="addStock({{ product.id }})" title="Add Stock">
                          <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="removeStock({{ product.id }})" title="Remove Stock">
                          <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleDisplay({{ product.id }})" title="Toggle Display">
                          <i class="fas fa-eye-slash"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct({{ product.id }})" title="Delete">
                          <i class="fas fa-trash"></i>
                        </button>
                        <a href="{{ url_for('product_descriptions', product_id=product.id) }}" class="btn btn-sm btn-info" title="Manage Descriptions">
                          <i class="fas fa-file-alt"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Products pagination">
              <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=pagination.prev_num) }}">Previous</a>
                </li>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                  {% if page_num %}
                    {% if page_num != pagination.page %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                  {% else %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=pagination.next_num) }}">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('add_product') }}" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="name">Product Name *</label>
                <input type="text" class="form-control" id="name" name="name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="productcode">Product Code</label>
                <input type="text" class="form-control" id="productcode" name="productcode">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="subcategory_id">Subcategory</label>
                <select class="form-control" id="subcategory_id" name="subcategory_id">
                  <option value="">Select Subcategory</option>
                  {% for subcategory in subcategories %}
                  <option value="{{ subcategory.id }}">{{ subcategory.name }} ({{ subcategory.category.name }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="branchid">Branch *</label>
                <select class="form-control" id="branchid" name="branchid" required>
                  <option value="">Select Branch</option>
                  {% for branch_option in branches %}
                  <option value="{{ branch_option.id }}" {% if branch_option.id == branch.id %}selected{% endif %}>{{ branch_option.name }} - {{ branch_option.location }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="buyingprice">Buying Price</label>
                <input type="number" class="form-control" id="buyingprice" name="buyingprice" min="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="sellingprice">Selling Price</label>
                <input type="number" class="form-control" id="sellingprice" name="sellingprice" min="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="stock">Initial Stock</label>
                <input type="number" class="form-control" id="stock" name="stock" min="0" value="0">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="image">Product Image</label>
                <input type="file" class="form-control" id="image" name="image" accept="image/*">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="display">Display Status</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="display" name="display" checked>
                  <label class="form-check-label" for="display">
                    Visible to customers
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1" aria-labelledby="addStockModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addStockModalLabel">Add Stock</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addStockForm" method="POST">
        <div class="modal-body">
          <div class="form-group">
            <label for="quantity">Quantity to Add</label>
            <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
          </div>
          <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Stock</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Remove Stock Modal -->
<div class="modal fade" id="removeStockModal" tabindex="-1" aria-labelledby="removeStockModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="removeStockModalLabel">Remove Stock</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="removeStockForm" method="POST">
        <div class="modal-body">
          <div class="form-group">
            <label for="removeQuantity">Quantity to Remove</label>
            <input type="number" class="form-control" id="removeQuantity" name="quantity" min="1" required>
          </div>
          <div class="form-group">
            <label for="removeNotes">Notes (Optional)</label>
            <textarea class="form-control" id="removeNotes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Remove Stock</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editProductForm" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="editName">Product Name *</label>
                <input type="text" class="form-control" id="editName" name="name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="editProductcode">Product Code</label>
                <input type="text" class="form-control" id="editProductcode" name="productcode">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="editSubcategoryId">Subcategory</label>
                <select class="form-control" id="editSubcategoryId" name="subcategory_id">
                  <option value="">Select Subcategory</option>
                  {% for subcategory in subcategories %}
                  <option value="{{ subcategory.id }}">{{ subcategory.name }} ({{ subcategory.category.name }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="editBranchid">Branch *</label>
                <select class="form-control" id="editBranchid" name="branchid" required>
                  <option value="">Select Branch</option>
                  {% for branch_option in branches %}
                  <option value="{{ branch_option.id }}">{{ branch_option.name }} - {{ branch_option.location }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="editBuyingprice">Buying Price</label>
                <input type="number" class="form-control" id="editBuyingprice" name="buyingprice" min="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="editSellingprice">Selling Price</label>
                <input type="number" class="form-control" id="editSellingprice" name="sellingprice" min="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="editStock">Stock</label>
                <input type="number" class="form-control" id="editStock" name="stock" min="0" readonly>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="editImage">Product Image</label>
                <input type="file" class="form-control" id="editImage" name="image" accept="image/*">
                <small class="form-text text-muted">Leave empty to keep current image</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="editDisplay">Display Status</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editDisplay" name="display">
                  <label class="form-check-label" for="editDisplay">
                    Visible to customers
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('productSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const displayFilter = document.getElementById('displayFilter');
    const table = document.getElementById('productsTable');
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');

    function filterProducts() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value.toLowerCase();
        const selectedDisplay = displayFilter.value;

        rows.forEach(row => {
            const name = row.cells[2].textContent.toLowerCase();
            const category = row.cells[3].textContent.toLowerCase();
            const display = row.cells[8].textContent.toLowerCase();

            const matchesSearch = name.includes(searchTerm);
            const matchesCategory = !selectedCategory || category.includes(selectedCategory);
            const matchesDisplay = !selectedDisplay || 
                (selectedDisplay === 'true' && display.includes('visible')) ||
                (selectedDisplay === 'false' && display.includes('hidden'));

            row.style.display = (matchesSearch && matchesCategory && matchesDisplay) ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterProducts);
    categoryFilter.addEventListener('change', filterProducts);
    displayFilter.addEventListener('change', filterProducts);
});

function clearFilters() {
    document.getElementById('productSearch').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('displayFilter').value = '';
    
    // Trigger filter to show all products
    const event = new Event('input');
    document.getElementById('productSearch').dispatchEvent(event);
}

// Product action functions
function addStock(productId) {
    document.getElementById('addStockForm').action = `/add_stock/${productId}`;
    new bootstrap.Modal(document.getElementById('addStockModal')).show();
}

function removeStock(productId) {
    document.getElementById('removeStockForm').action = `/remove_stock/${productId}`;
    new bootstrap.Modal(document.getElementById('removeStockModal')).show();
}

function editProduct(productId) {
    // Fetch product data and populate modal
    fetch(`/get_product/${productId}`)
        .then(response => response.json())
        .then(product => {
            document.getElementById('editName').value = product.name;
            document.getElementById('editProductcode').value = product.productcode || '';
            document.getElementById('editSubcategoryId').value = product.subcategory_id || '';
            document.getElementById('editBranchid').value = product.branchid;
            document.getElementById('editBuyingprice').value = product.buyingprice || '';
            document.getElementById('editSellingprice').value = product.sellingprice || '';
            document.getElementById('editStock').value = product.stock || 0;
            document.getElementById('editDisplay').checked = product.display;
            
            document.getElementById('editProductForm').action = `/edit_product/${productId}`;
            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        })
        .catch(error => {
            console.error('Error fetching product:', error);
            alert('Error loading product data');
        });
}

function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_product/${productId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function toggleDisplay(productId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/toggle_display/${productId}`;
    document.body.appendChild(form);
    form.submit();
}

function viewProduct(productId) {
    window.open(`/product_details/${productId}`, '_blank');
}
</script>
{% endblock %} 
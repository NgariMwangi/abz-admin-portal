<!-- Branch Products Table Partial - Used for AJAX updates -->
<div class="table-responsive">
  <table class="table table-hover" id="productsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Image</th>
        <th>Name</th>
        <th>Category</th>
        <th>Buying Price</th>
        <th>Selling Price</th>
        <th>Stock</th>
        <th>Product Code</th>
        <th>Display</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for branch_product in branch_products %}
      <tr>
        <td>{{ branch_product.id }}</td>
        <td>
          {% if branch_product.catalog_product and branch_product.catalog_product.image_url %}
          <img src="{{ branch_product.catalog_product.image_url }}" alt="{{ branch_product.catalog_product.name }}" style="width: 50px; height: 50px; object-fit: cover;">
          {% else %}
          <span class="text-muted">No image</span>
          {% endif %}
        </td>
        <td>
          {% if branch_product.catalog_product %}
            {{ branch_product.catalog_product.name }}
          {% else %}
            <span class="text-muted">Unknown Product</span>
          {% endif %}
        </td>
        <td>
          {% if branch_product.catalog_product and branch_product.catalog_product.subcategory_id %}
            {% for subcategory in subcategories %}
              {% if subcategory.id == branch_product.catalog_product.subcategory_id %}
                {{ subcategory.name }} ({{ subcategory.category.name }})
              {% endif %}
            {% endfor %}
          {% else %}
            <span class="text-muted">No category</span>
          {% endif %}
        </td>
        <td>{{ branch_product.buyingprice or 'N/A' }}</td>
        <td>{{ branch_product.sellingprice or 'N/A' }}</td>
        <td>
          <span class="badge {% if branch_product.stock > 10 %}badge-success{% elif branch_product.stock > 0 %}badge-warning{% else %}badge-danger{% endif %}">
            {{ branch_product.stock | format_stock }}
          </span>
        </td>
        <td>
          {% if branch_product.catalog_product %}
            {{ branch_product.catalog_product.productcode or 'N/A' }}
          {% else %}
            N/A
          {% endif %}
        </td>
        <td>
          <span class="badge {% if branch_product.display %}badge-success{% else %}badge-secondary{% endif %}">
            {{ 'Visible' if branch_product.display else 'Hidden' }}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-success" onclick="addStock({{ branch_product.id }})" title="Add Stock">
              <i class="fas fa-plus"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="removeStock({{ branch_product.id }})" title="Remove Stock">
              <i class="fas fa-minus"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="window.location.href='{{ url_for('stock_history', branch_product_id=branch_product.id) }}'" title="Stock History">
              <i class="fas fa-history"></i>
            </button>
            <a href="{{ url_for('product_descriptions', product_id=branch_product.catalog_product.id) if branch_product.catalog_product else '#' }}" class="btn btn-sm btn-info" title="Manage Descriptions">
              <i class="fas fa-file-alt"></i>
            </a>
            <button class="btn btn-sm btn-primary" onclick="editBranchProduct({{ branch_product.id }})" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="toggleDisplay({{ branch_product.id }})" title="Toggle Display">
              <i class="fas {% if branch_product.display %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteBranchProduct({{ branch_product.id }})" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="Branch products pagination">
  <ul class="pagination justify-content-center">
    {% if pagination.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=pagination.prev_num, search=search, category=category_filter, display=display_filter, per_page=pagination.per_page) }}">
        <i class="fas fa-chevron-left"></i> Previous
      </a>
    </li>
    {% endif %}
    
    {% for page_num in pagination.iter_pages() %}
      {% if page_num %}
        {% if page_num != pagination.page %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=page_num, search=search, category=category_filter, display=display_filter, per_page=pagination.per_page) }}">{{ page_num }}</a>
        </li>
        {% else %}
        <li class="page-item active">
          <span class="page-link">{{ page_num }}</span>
        </li>
        {% endif %}
      {% else %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
      {% endif %}
    {% endfor %}
    
    {% if pagination.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('branch_products', branch_id=branch.id, page=pagination.next_num, search=search, category=category_filter, display=display_filter, per_page=pagination.per_page) }}">
        Next <i class="fas fa-chevron-right"></i>
      </a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Result Count -->
<div class="text-center text-muted mt-3">
  Showing {{ pagination.items|length }} of {{ pagination.total }} branch products in {{ branch.name }}
  {% if search or category_filter or display_filter %}
    (filtered results)
  {% endif %}
</div>
